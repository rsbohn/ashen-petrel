; Build a bitmap of primes for odd numbers < 10,000.
; Bit index i represents odd n = 2*i + 3 (i=0 -> 3). Bit=1 means prime.
; The table is 313 words (5008 bits); the last word is masked to 4999 bits.
;
; Step 1: print "lptradix 8" and HALT so the user can set the printer radix.
; Step 2: continue to build the table and emit it via WIO 1.

    ORG 0
START:
    LDI 154     ; l
    WIO 0
    LDI 160     ; p
    WIO 0
    LDI 164     ; t
    WIO 0
    LDI 162     ; r
    WIO 0
    LDI 141     ; a
    WIO 0
    LDI 144     ; d
    WIO 0
    LDI 151     ; i
    WIO 0
    LDI 170     ; x
    WIO 0
    LDI 40      ; space
    WIO 0
    LDI 70      ; 8
    WIO 0
    LDI 12      ; LF
    WIO 0
    HALT

CONTINUE:
    LDI 0
    STAX         ; X = 0

INIT_LOOP:
    LOAD FULL
    STOR TABLE,X
    INCX
    LDXA
    LOAD WORD_COUNT
    SUB
    DEL
    BL INIT_CONT
    BR INIT_DONE
INIT_CONT:
    BR INIT_LOOP
INIT_DONE:
    LDI 0
    STOR I

SIEVE_LOOP:
    ; p = 2*i + 3
    LOAD I
    DUP
    ADD
    LDI 3
    ADD
    STOR N

    ; if p > 99, exit sieve
    LOAD N
    LDI 143
    SUB
    DEL
    BG SIEVE_EXIT
    BR SIEVE_BODY
SIEVE_EXIT:
    BR SIEVE_DONE
SIEVE_BODY:
    ; test bit for index i
    LOAD I
    LDI 20
    DIV
    STOR BIT_IDX
    STOR WORD_IDX
    LOAD WORD_IDX
    STAX
    LOAD TABLE,X
    LOAD BIT_IDX
    STAX
    LOAD MASKS,X
    AND
    TEST
    DEL
    BE SIEVE_SKIP
    BR MARK_START
SIEVE_SKIP:
    BR SIEVE_NEXT

MARK_START:
    ; j = (p*p - 3) / 2
    LOAD N
    DUP
    MPY
    STOR N2
    LOAD N2
    LDI 3
    SUB
    LDI 2
    DIV
    DEL
    STOR J

MARK_LOOP:
    LOAD J
    LOAD LAST_INDEX
    SUB
    DEL
    BG MARK_EXIT
    BR MARK_BODY
MARK_EXIT:
    BR MARK_DONE
MARK_BODY:
    ; clear bit at index j
    LOAD J
    LDI 20
    DIV
    STOR BIT_IDX
    STOR WORD_IDX
    LOAD WORD_IDX
    STAX
    LOAD TABLE,X
    LOAD BIT_IDX
    STAX
    LOAD MASKS,X
    NOT
    AND
    LOAD WORD_IDX
    STAX
    STOR TABLE,X

    LOAD J
    LOAD N
    ADD
    STOR J
    BR MARK_LOOP

MARK_DONE:
SIEVE_NEXT:
    LOAD I
    LDI 1
    ADD
    STOR I
    BR SIEVE_LOOP

SIEVE_DONE:
    ; clear unused bits beyond 9999
    LOAD LAST_WORD_INDEX
    STAX
    LOAD TABLE,X
    LOAD LAST_WORD_MASK
    AND
    LOAD LAST_WORD_INDEX
    STAX
    STOR TABLE,X

    ; output table via LPT (WIO 1)
    LDI 0
    STAX

OUT_LOOP:
    LOAD TABLE,X
    WIO 1
    INCX
    LDXA
    LOAD WORD_COUNT
    SUB
    DEL
    BL OUT_CONT
    BR OUT_DONE
OUT_CONT:
    BR OUT_LOOP
OUT_DONE:
    HALT

; --- Variables and constants (must remain within 0..0777) ---
I:              DW 000000
N:              DW 000000
N2:             DW 000000
J:              DW 000000
WORD_IDX:       DW 000000
BIT_IDX:        DW 000000

WORD_COUNT:     DW #313
LAST_INDEX:     DW #4998
LAST_WORD_INDEX: DW #312
FULL:           DW 177777
LAST_WORD_MASK: DW 000177

; bit masks for 0..15
MASKS:
    DW 000001 000002 000004 000010 000020 000040 000100 000200
    DW 000400 001000 002000 004000 010000 020000 040000 100000

; 313-word table of primacy bits for odds starting at 3
TABLE:
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000 000000 000000 000000 000000 000000 000000 000000
    DW 000000
